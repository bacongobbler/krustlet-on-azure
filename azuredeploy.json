{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"_artifactsLocation": {
			"type": "string",
			"metadata": {
				"description": "The base URI where artifacts required by this template are located. For example, if stored on a public GitHub repo, you'd use the following URI: https://raw.githubusercontent.com/bacongobbler/krustlet-on-azure/main/."
			},
			"defaultValue": "https://raw.githubusercontent.com/bacongobbler/krustlet-on-azure/main/"
		},
		"_artifactsLocationSasToken": {
			"type": "securestring",
			"defaultValue": "",
			"metadata": {
				"description": "The sasToken required to access _artifactsLocation.  If your artifacts are stored on a public repo or public storage account you can leave this blank."
			}
		},
		"adminUsername": {
			"type": "string",
			"defaultValue": "krustlet",
			"metadata": {
				"description": "Admin user name you will use to log on to the Virtual Machines. If left blank, a random username will be generated. (optional)"
			}
		},
		"sshPublicKey": {
			"type": "securestring",
			"metadata": {
				"description": "SSH Public Key data for SSH'ing into the Virtual Machines. If one is not provided, a public key will be generated. (optional)"
			}
		},
		"location": {
			"type": "string",
			"defaultValue": "[resourceGroup().location]",
			"metadata": {
				"description": "The region where the cluster will be deployed."
			}
		},
		"krustletURL": {
			"type": "string",
			"defaultValue": "https://krustlet.blob.core.windows.net/releases/krustlet-canary-linux-amd64.tar.gz",
			"metadata": {
				"description": "URL to a Krustlet release archive."
			}
		},
		"virtualMachineSize": {
			"type": "string",
			"defaultValue": "Standard_DS2_V2",
			"metadata": {
				"description": "This is the Azure Virtual Machine size, and will affect the cost. If you don't know, just leave the default value."
			}
		},
		"clusterName": {
			"defaultValue": "krustlet",
			"type": "string",
			"metadata": {
				"description": "Name of the Kubernetes cluster."
			}
		},
		"kubernetesVersion": {
			"defaultValue": "1.17.11",
			"type": "string",
			"metadata": {
				"description": "Determines which version of Kubernetes will be deployed."
			}
		},
		"dnsPrefix": {
			"type": "string",
			"metadata": {
				"description": "DNS prefix to use with the Kubernetes API server's fully-qualified domain name. (optional)"
			}
		},
		"servicePrincipalClientId": {
			"type": "securestring",
			"metadata": {
				"description": "Service principal client ID. If left blank, one will be generated for you. (optional)"
			}
		},
		"servicePrincipalClientSecret": {
			"type": "securestring",
			"metadata": {
				"description": "Service principal client secret. If left blank, one will be generated for you. (optional)"
			}
		}
	},
	"variables": {
		"addressPrefix": "10.0.0.0/16",
		"imageOffer": "UbuntuServer",
		"imagePublisher": "Canonical",
		"linuxConfiguration": {
			"disablePasswordAuthentication": true,
			"ssh": {
				"publicKeys": [
					{
						"path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
						"keyData": "[parameters('sshPublicKey')]"
					}
				]
			}
		},
		"ubuntuOSVersion": "18.04-LTS",
		"virtualNetworkName": "aks-vnet",
		"subnetName": "subnet",
		"subnetPrefix": "10.0.0.0/24",
		"subnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('subnetName'))]",
		"vmName": "krustlet-wasi"
	},
	"resources": [
		{
			"name": "[concat(variables('vmName'),'/newuserscript')]",
			"type": "Microsoft.Compute/virtualMachines/extensions",
			"apiVersion": "2018-06-01",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
			],
			"properties": {
				"publisher": "Microsoft.Azure.Extensions",
				"type": "CustomScript",
				"typeHandlerVersion": "2.0",
				"autoUpgradeMinorVersion": true,
				"settings": {
					"fileUris": [
						"[uri(parameters('_artifactsLocation'), concat('install_krustlet.sh', parameters('_artifactsLocationSasToken')))]"
					],
					"commandToExecute": "[concat('bash install_krustlet.sh', ' ', parameters('krustletURL'))]"
				}
			}
		},
		{
			"name": "[variables('vmName')]",
			"type": "Microsoft.Compute/virtualMachines",
			"apiVersion": "2018-06-01",
			"location": "[parameters('location')]",
			"properties": {
				"hardwareProfile": {
					"vmSize": "[parameters('virtualMachineSize')]"
				},
				"osProfile": {
					"computerName": "[variables('vmName')]",
					"adminUsername": "[parameters('adminUsername')]",
					"linuxConfiguration": "[variables('linuxConfiguration')]"
				},
				"storageProfile": {
					"imageReference": {
						"publisher": "[variables('imagePublisher')]",
						"offer": "[variables('imageOffer')]",
						"sku": "[variables('ubuntuOSVersion')]",
						"version": "latest"
					},
					"osDisk": {
						"caching": "ReadWrite",
						"createOption": "FromImage",
						"diskSizeGB": 100
					}
				}
			}
		},
		{
			"type": "Microsoft.ContainerService/managedClusters",
			"apiVersion": "2020-09-01",
			"name": "[parameters('clusterName')]",
			"location": "[parameters('location')]",
			"properties": {
				"kubernetesVersion": "[parameters('kubernetesVersion')]",
				"dnsPrefix": "[parameters('dnsPrefix')]",
				"agentPoolProfiles": [
					{
						"name": "nodepool1",
						"count": 3,
						"vmSize": "[parameters('virtualMachineSize')]",
						"osDiskSizeGB": 128,
						"osDiskType": "Managed",
						"maxPods": 110,
						"type": "VirtualMachineScaleSets",
						"orchestratorVersion": "[parameters('kubernetesVersion')]",
						"enableNodePublicIP": false,
						"nodeLabels": {},
						"mode": "System",
						"osType": "Linux"
					}
				],
				"linuxProfile": {
					"adminUsername": "[parameters('adminUsername')]",
					"ssh": "[variables('linuxConfiguration.ssh')]"
				},
				"servicePrincipalProfile": {
					"clientId": "[parameters('servicePrincipalClientId')]",
					"Secret": "[parameters('servicePrincipalClientSecret')]"
				}
			}
		},
		{
			"type": "Microsoft.ContainerService/managedClusters/agentPools",
			"apiVersion": "2020-09-01",
			"name": "[concat(parameters('clusterName'), '/nodepool1')]",
			"dependsOn": [
				"[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]"
			],
			"properties": {
				"count": 3,
				"vmSize": "[parameters('virtualMachineSize')]",
				"osDiskSizeGB": 128,
				"osDiskType": "Managed",
				"maxPods": 110,
				"type": "VirtualMachineScaleSets",
				"orchestratorVersion": "[parameters('kubernetesVersion')]",
				"enableNodePublicIP": false,
				"nodeLabels": {},
				"mode": "System",
				"osType": "Linux"
			}
		}
	]
}
